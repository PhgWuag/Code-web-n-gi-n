<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω h√†ng h√≥a</title>
<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.container { max-width:1200px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
h1 { text-align:center; }
.user-info { 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  background: #e7f3ff; 
  padding: 12px 16px; 
  border-radius: 6px; 
  margin-bottom: 20px;
}
.user-name { 
  font-weight: bold; 
  color: #333; 
}
.btn-logout {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}
.btn-logout:hover {
  background: #c82333;
}
input { width:100%; padding:8px; margin-bottom:8px; }
button { padding:6px 12px; margin:2px; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
.summary { background:#f9f9f9; padding:15px; margin-top:20px; border-radius:6px; }
.note-section { background:#fff3cd; padding:10px; margin:10px 0; border-radius:4px; border:1px solid #ffc107; }
.note-section textarea { width:100%; padding:8px; resize:vertical; min-height:60px; }
.edit-note { background:#e7f3ff; padding:8px; margin:5px 0; border-radius:4px; font-style:italic; }

/* MODAL */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
}
.modal-content {
  background:#fff;
  max-width:600px;
  margin:10% auto;
  padding:20px;
  border-radius:6px;
}
.history-item {
  border-bottom:1px solid #ddd;
  padding:8px 0;
}
.history-time { font-weight:bold; }
</style>
</head>
<body>

<div class="container">
<h1>Qu·∫£n l√Ω h√†ng h√≥a</h1>

<div class="user-info">
  <div>
    <span style="color: #666;">Xin ch√†o,</span>
    <span class="user-name" id="userName">User</span>
  </div>
  <button class="btn-logout" onclick="dangXuat()">ƒêƒÉng xu·∫•t</button>
</div>

<input type="date" id="ngayNhap">
<input type="text" id="tenHang" placeholder="T√™n h√†ng">
<input type="number" id="soLuongNhap" placeholder="SL nh·∫≠p">
<input type="date" id="thoiGianTra">
<input type="number" id="soLuongTra" placeholder="SL tr·∫£">

<div id="noteSection" class="note-section" style="display:none;">
  <label><b>Ghi ch√∫ ch·ªânh s·ª≠a:</b></label>
  <textarea id="ghiChuSua" placeholder="Nh·∫≠p l√Ω do ch·ªânh s·ª≠a (VD: Kh√°ch tr·∫£ th√™m h√†ng, Nh·∫≠p nh·∫ßm s·ªë l∆∞·ª£ng, C·∫≠p nh·∫≠t theo h√≥a ƒë∆°n m·ªõi...)"></textarea>
</div>

<button id="btnLuu" onclick="luuHoacCapNhat()">L∆∞u</button>

<table>
<thead>
<tr>
<th>Ng√†y nh·∫≠p</th>
<th>T√™n h√†ng</th>
<th>SL nh·∫≠p</th>
<th>Ng√†y tr·∫£</th>
<th>SL tr·∫£</th>
<th>Ghi ch√∫</th>
<th>H√†nh ƒë·ªông</th>
</tr>
</thead>
<tbody id="bang"></tbody>
</table>

<div class="summary">
<p>T·ªïng nh·∫≠p: <b id="tongNhap">0</b></p>
<p>T·ªïng tr·∫£: <b id="tongTra">0</b></p>
<p>T·ªìn kho: <b id="tonKho">0</b></p>
</div>
</div>

<!-- MODAL L·ªäCH S·ª¨ -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>L·ªãch s·ª≠ ch·ªânh s·ª≠a</h3>
    <div id="lichSu"></div>
    <button onclick="dongModal()">ƒê√≥ng</button>
  </div>
</div>

<script src="config.js"></script>
<script>
const API_URL = CONFIG.API_URL + "/hanghoa";
const AUTH_API_URL = CONFIG.API_URL + "/auth";

let danhSach = [];
let editId = null;
let token = localStorage.getItem("token");
let currentUser = JSON.parse(localStorage.getItem("user") || "{}");

// ==================== KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ====================
if (!token) {
    window.location.href = "auth.html";
}

// Hi·ªÉn th·ªã t√™n user
document.getElementById("userName").textContent = currentUser.fullName || currentUser.username || "User";

// ==================== H√ÄM G·ªåI API V·ªöI TOKEN ====================
async function apiCall(url, options = {}) {
    const headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
        ...options.headers
    };

    try {
        const response = await fetch(url, { ...options, headers });
        
        // N·∫øu token kh√¥ng h·ª£p l·ªá, chuy·ªÉn v·ªÅ trang login
        if (response.status === 401 || response.status === 403) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
            window.location.href = "auth.html";
            return null;
        }

        return await response.json();
    } catch (error) {
        console.error("API Error:", error);
        throw error;
    }
}

// ==================== ƒêƒÇNG XU·∫§T ====================
function dangXuat() {
    if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "auth.html";
    }
}

// ==================== LOAD D·ªÆ LI·ªÜU T·ª™ API ====================
async function taiDuLieu() {
    try {
        const result = await apiCall(API_URL, { method: "GET" });
        
        if (result && result.success) {
            danhSach = result.data;
            hienThi();
            capNhatTongKet(result.summary);
        }
    } catch (error) {
        console.error("Kh√¥ng th·ªÉ k·∫øt n·ªëi API:", error);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra server ƒë√£ ch·∫°y ch∆∞a!");
    }
}

// ==================== HI·ªÇN TH·ªä B·∫¢NG ====================
function hienThi() {
    bang.innerHTML = "";

    danhSach.forEach((item) => {
        const noteCount = (item.history || []).filter(h => h.note).length;
        const noteDisplay = noteCount > 0 ? `${noteCount} ghi ch√∫` : "‚Äî";

        bang.innerHTML += `
        <tr>
            <td>${item.ngayNhap}</td>
            <td>${item.tenHang}</td>
            <td>${item.soLuongNhap}</td>
            <td>${item.thoiGianTra || ""}</td>
            <td>${item.soLuongTra}</td>
            <td>${noteDisplay}</td>
            <td>
              <button onclick="batDauSua(${item.id})">S·ª≠a</button>
              <button onclick="xemLichSu(${item.id})">Xem l·ªãch s·ª≠ & ghi ch√∫</button>
              <button onclick="xoaBanGhi(${item.id})" style="background:#dc3545; color:#fff;">X√≥a</button>
            </td>
        </tr>`;
    });
}

// ==================== C·∫¨P NH·∫¨T T·ªîNG K·∫æT ====================
function capNhatTongKet(summary) {
    if (summary) {
        document.getElementById("tongNhap").innerText = summary.tongNhap;
        document.getElementById("tongTra").innerText = summary.tongTra;
        document.getElementById("tonKho").innerText = summary.tonKho;
    }
}

// ==================== B·∫ÆT ƒê·∫¶U S·ª¨A ====================
function batDauSua(id) {
    const item = danhSach.find(h => h.id === id);
    if (!item) return;
    
    ngayNhap.value = item.ngayNhap;
    tenHang.value = item.tenHang;
    soLuongNhap.value = item.soLuongNhap;
    thoiGianTra.value = item.thoiGianTra;
    soLuongTra.value = item.soLuongTra;

    editId = id;
    btnLuu.innerText = "C·∫≠p nh·∫≠t";
    
    // Hi·ªÉn th·ªã √¥ ghi ch√∫ khi s·ª≠a
    document.getElementById("noteSection").style.display = "block";
    document.getElementById("ghiChuSua").value = "";
}

// ==================== L∆ØU HO·∫∂C C·∫¨P NH·∫¨T ====================
async function luuHoacCapNhat() {
    if (!tenHang.value || !ngayNhap.value) {
        alert("Thi·∫øu th√¥ng tin");
        return;
    }

    const data = {
        ngayNhap: ngayNhap.value,
        tenHang: tenHang.value,
        soLuongNhap: soLuongNhap.value || 0,
        thoiGianTra: thoiGianTra.value,
        soLuongTra: soLuongTra.value || 0
    };

    try {
        let result;
        
        // TH√äM M·ªöI
        if (editId === null) {
            result = await apiCall(API_URL, {
                method: "POST",
                body: JSON.stringify(data)
            });
        }
        // C·∫¨P NH·∫¨T
        else {
            const ghiChu = document.getElementById("ghiChuSua").value.trim();
            if (ghiChu) {
                data.note = ghiChu;
            }
            
            result = await apiCall(`${API_URL}/${editId}`, {
                method: "PUT",
                body: JSON.stringify(data)
            });
            
            editId = null;
            btnLuu.innerText = "L∆∞u";
            document.getElementById("noteSection").style.display = "none";
        }

        if (result && result.success) {
            alert(result.message);
            await taiDuLieu(); // Reload d·ªØ li·ªáu
            resetForm();
        } else if (result) {
            alert("L·ªói: " + result.message);
        }
    } catch (error) {
        console.error("L·ªói:", error);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
    }
}

// ==================== XEM L·ªäCH S·ª¨ ====================
function xemLichSu(id) {
    const item = danhSach.find(h => h.id === id);
    if (!item) return;
    
    const lichSu = document.getElementById("lichSu");
    lichSu.innerHTML = "";

    const history = item.history;

    if (!history || history.length === 0) {
        lichSu.innerHTML = "<p>Ch∆∞a c√≥ ch·ªânh s·ª≠a</p>";
    } else {
        history.forEach(h => {
            let noteHtml = "";
            if (h.note) {
                noteHtml = `<div class="edit-note">üìù <b>Ghi ch√∫:</b> ${h.note}</div>`;
            }
            
            lichSu.innerHTML += `
            <div class="history-item">
              <div class="history-time">${h.time}</div>
              <ul>
                ${h.changes.map(c => `<li>${c}</li>`).join("")}
              </ul>
              ${noteHtml}
            </div>`;
        });
    }

    modal.style.display = "block";
}

// ==================== ƒê√ìNG MODAL ====================
function dongModal() {
    modal.style.display = "none";
}

// ==================== X√ìA B·∫¢N GHI ====================
async function xoaBanGhi(id) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y kh√¥ng?")) {
        return;
    }
    
    try {
        const result = await apiCall(`${API_URL}/${id}`, {
            method: "DELETE"
        });
        
        if (result && result.success) {
            alert(result.message);
            
            // N·∫øu ƒëang s·ª≠a b·∫£n ghi b·ªã x√≥a, reset form
            if (editId === id) {
                resetForm();
                editId = null;
                btnLuu.innerText = "L∆∞u";
                document.getElementById("noteSection").style.display = "none";
            }
            
            await taiDuLieu(); // Reload d·ªØ li·ªáu
        } else if (result) {
            alert("L·ªói: " + result.message);
        }
    } catch (error) {
        console.error("L·ªói:", error);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
    }
}

// ==================== RESET FORM ====================
function resetForm() {
    ngayNhap.value = "";
    tenHang.value = "";
    soLuongNhap.value = "";
    thoiGianTra.value = "";
    soLuongTra.value = "";
    document.getElementById("ghiChuSua").value = "";
    document.getElementById("noteSection").style.display = "none";
    editId = null;
    btnLuu.innerText = "L∆∞u";
}

// ==================== KH·ªûI T·∫†O ====================
taiDuLieu();
</script>

</body>
</html>
